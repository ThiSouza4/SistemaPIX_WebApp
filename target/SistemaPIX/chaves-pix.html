<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Chaves PIX</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000;visibility:hidden;opacity:0;transition:opacity .3s ease,visibility 0s .3s}.modal-overlay.visible{visibility:visible;opacity:1;transition-delay:0s}.modal-content{background-color:var(--card-color);color:var(--text-primary);padding:30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.4);text-align:center;max-width:400px;width:90%;border:1px solid var(--card-border-color)}.modal-content h3{margin-top:0}#modal-input{margin-top:15px;margin-bottom:25px;width:100%;background-color:var(--input-bg);border:1px solid var(--input-border);border-radius:8px;padding:12px 15px;color:var(--text-primary);font-size:16px;box-sizing:border-box}.modal-buttons{display:flex;justify-content:center;gap:15px;margin-top:25px}.modal-buttons button{padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700;border:none;min-width:100px}#modal-confirm-btn{background-color:#007BFF;color:#fff}#modal-cancel-btn{background-color:#555;color:#ccc}
    </style>
</head>
<body>
    <div class="main-container">
        <a href="dashboard.html" class="form-link">&larr; Voltar ao Painel</a>
        <div class="card">
            <h3>Cadastrar Nova Chave</h3>
            <form id="add-key-form">
                <div class="input-group"><label for="tipo_chave">Tipo de Chave</label><select id="tipo_chave" name="tipo_chave" required><option value="CPF">CPF</option><option value="EMAIL">E-mail</option><option value="CELULAR">Celular</option><option value="ALEATORIA">Chave Aleatória</option></select></div>
                <div class="input-group"><label for="chave">Chave</label><input type="text" id="chave" name="chave" placeholder="Digite a chave" required></div>
                <button type="submit" class="btn-primary">Adicionar Chave</button>
                <div id="add-key-message" class="message" style="display:none"></div>
            </form>
        </div>
        <div class="card">
            <h3>Minhas Chaves Cadastradas</h3>
            <div id="keys-list"><p>Carregando chaves...</p></div>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-buttons"><button id="modal-cancel-btn">Cancelar</button><button id="modal-confirm-btn">Confirmar</button></div>
        </div>
    </div>
    
    <script>
        // --- FUNÇÕES DE VALIDAÇÃO E MÁSCARA ---
        function validateEmail(email) { const re = /^[a-zA-Z0-9._%+-]{3,}@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?$/; return re.test(String(email).toLowerCase()); }
        function applyMask(v, mask, max) { let r = mask(v); return r.length > max ? r.slice(0, max) : r; }
        function cpfMask(v) { return v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2'); }
        function phoneMask(v) { return v.replace(/\D/g, '').replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2'); }
        function formatKeyForDisplay(type, value) {
            if (type === 'CPF') return cpfMask(value);
            if (type === 'CELULAR') return phoneMask(value);
            return value; // Para EMAIL e ALEATORIA, retorna o valor original
        }

        document.addEventListener('DOMContentLoaded', () => {
            const keysListDiv = document.getElementById('keys-list'), addKeyForm = document.getElementById('add-key-form'), addKeyMessage = document.getElementById('add-key-message'), tipoChaveSelect = document.getElementById('tipo_chave'), chaveInput = document.getElementById('chave'), modal = document.getElementById('confirmation-modal');
            let currentAction = null;
            document.getElementById('modal-cancel-btn').addEventListener('click',()=>modal.classList.remove('visible'));
            document.getElementById('modal-confirm-btn').addEventListener('click',()=>{if(currentAction)currentAction()});
            
            function openModal(c){document.getElementById('modal-title').textContent=c.title;document.getElementById('modal-body').innerHTML=c.body;const b=document.getElementById('modal-confirm-btn');b.textContent=c.confirmText;b.style.backgroundColor=c.confirmColor;currentAction=c.action;modal.classList.add('visible');const i=document.getElementById('modal-input');if(i&&c.keyType){i.maxLength=c.maxLength;i.addEventListener('input',()=>{if(c.keyType==='CPF')i.value=applyMask(i.value,cpfMask,14);if(c.keyType==='CELULAR')i.value=applyMask(i.value,phoneMask,15)})}}
            
            async function fetchAndRenderKeys(){keysListDiv.innerHTML='<p>Carregando chaves...</p>';try{const r=await fetch('api/data/keys');if(!r.ok)throw new Error('Falha ao buscar chaves.');const k=await r.json();renderKeys(k)}catch(e){keysListDiv.innerHTML='<p class="error-message">Erro ao carregar chaves.</p>'}}
            
            function renderKeys(keys){
                keysListDiv.innerHTML = !keys || keys.length === 0 ? '<p>Nenhuma chave cadastrada.</p>' : '';
                if (!keys) return;
                keys.forEach(key => {
                    const keyCard = document.createElement('div');
                    keyCard.className = 'key-card';
                    let buttonsHtml = `<button class="delete-btn" data-id="${key.id_chave}">Excluir</button>`;
                    if (key.tipo_chave !== 'ALEATORIA') {
                        buttonsHtml = `<button class="update-btn" data-id="${key.id_chave}" data-chave="${key.chave}" data-tipo="${key.tipo_chave}">Alterar</button>` + buttonsHtml;
                    }
                    // A CORREÇÃO FINAL ESTÁ AQUI vvv (usando a função correta)
                    keyCard.innerHTML = `<div class="key-info"><strong>${key.tipo_chave}</strong><span>${formatKeyForDisplay(key.tipo_chave, key.chave)}</span></div><div class="key-actions">${buttonsHtml}</div>`;
                    keysListDiv.appendChild(keyCard);
                });
                addEventListenersToButtons();
            }
            
            function addEventListenersToButtons(){document.querySelectorAll('.delete-btn').forEach(b=>b.addEventListener('click',handleDelete));document.querySelectorAll('.update-btn').forEach(b=>b.addEventListener('click',handleUpdate))}
            
            function handleDelete(e){const k=e.target.getAttribute('data-id');openModal({title:'Confirmar Exclusão',body:'<p>Você tem certeza?</p>',confirmText:'Excluir',confirmColor:'#e74c3c',action:async()=>{try{const r=await fetch('api/data/keys?id='+k,{method:'DELETE'});if(!r.ok){const d=await r.json();throw new Error(d.message)}modal.classList.remove('visible');fetchAndRenderKeys()}catch(err){alert(err.message)}}})}
            
            function handleUpdate(e){const i=e.target.getAttribute('data-id'),t=e.target.getAttribute('data-tipo'),c=e.target.getAttribute('data-chave'),m=t==='CPF'?14:t==='CELULAR'?15:50;openModal({title:'Alterar Chave '+t,body:`<div class="input-group"><input type="text" id="modal-input" value="${c}" maxlength="${m}"></div>`,confirmText:'Alterar',confirmColor:'#007BFF',keyType:t,maxLength:m,action:async()=>{const n=document.getElementById('modal-input').value;if(!n||n===c){modal.classList.remove('visible');return}try{const r=await fetch('api/data/keys',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id_chave:parseInt(i),chave:n})});if(!r.ok){const d=await r.json();throw new Error(d.message)}modal.classList.remove('visible');fetchAndRenderKeys()}catch(err){alert(err.message)}}})}
            
            addKeyForm.addEventListener('submit',async e=>{e.preventDefault();const t=tipoChaveSelect.value,c=chaveInput.value;if(t==='EMAIL'&&!validateEmail(c)){addKeyMessage.textContent='Por favor, insira um e-mail válido.';addKeyMessage.className='message error-message';addKeyMessage.style.display='block';return}try{const r=await fetch('api/data/keys',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo_chave:t,chave:c})});const d=await r.json();addKeyMessage.textContent=d.message;addKeyMessage.className=r.ok?'message success-message':'message error-message';addKeyMessage.style.display='block';if(r.ok){addKeyForm.reset();tipoChaveSelect.dispatchEvent(new Event('change'));fetchAndRenderKeys()}}catch(err){addKeyMessage.textContent='Erro de conexão.';addKeyMessage.className='message error-message'}});
            
            function handleMainInputMask(){const t=tipoChaveSelect.value;chaveInput.disabled=t==='ALEATORIA';chaveInput.value=t==='ALEATORIA'?'Será gerada automaticamente':'';chaveInput.maxLength=50;if(t==='CPF')chaveInput.maxLength=14;if(t==='CELULAR')chaveInput.maxLength=15}
            
            tipoChaveSelect.addEventListener('change',handleMainInputMask);
            chaveInput.addEventListener('input',()=>{const t=tipoChaveSelect.value;if(t==='CPF')chaveInput.value=applyMask(chaveInput.value,cpfMask,14);if(t==='CELULAR')chaveInput.value=applyMask(chaveInput.value,phoneMask,15)});
            
            handleMainInputMask();
            fetchAndRenderKeys();
        });
    </script>
    <script src="js/global.js"></script>
</body>
</html>
